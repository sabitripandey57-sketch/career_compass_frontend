<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Career Compass</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .admin-header {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            border-left: 4px solid #dc3545;
        }
        
        .stat-card h3 {
            margin: 0;
            font-size: 2.5em;
            color: #dc3545;
        }
        
        .stat-card p {
            margin: 5px 0 0;
            color: #666;
            font-weight: 500;
        }
        
        .admin-tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .tab-button.active {
            background: #dc3545;
            color: white;
        }
        
        .tab-button:hover {
            background: #dc3545;
            color: white;
        }
        
        .tab-content {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .form-group textarea {
            height: 100px;
            resize: vertical;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: #dc3545;
            color: white;
        }
        
        .btn-primary:hover {
            background: #c82333;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        
        .data-table tr:hover {
            background: #f8f9fa;
        }
        
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 500;
        }
        
        .badge-admin {
            background: #dc3545;
            color: white;
        }
        
        .badge-student {
            background: #007bff;
            color: white;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }
        
        .pagination button {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .pagination button.active {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }
        
        .search-bar {
            margin-bottom: 20px;
        }
        
        .search-bar input {
            width: 300px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    
    <!-- top banner -->
    <div class="top-banner">
        <div>
            <div class="banner-text">Admin Dashboard - Career Compass</div>
        </div>
    </div>

    <!-- nav bar -->
    <nav>
        <div class="container main-nav flex">
            <a href="#" class="logo">
                <img src="/images/mylogo.png" alt="">
            </a>
            <div class="nav-link">
                <ul class="flex">
                    <!-- Navigation will be updated by auth.js -->
                </ul>
            </div>
        </div>
    </nav>

    <div class="admin-container">
        <!-- Admin Header -->
        <div class="admin-header">
            <h1>Admin Dashboard</h1>
            <p id="admin-greeting">Managing Career Compass System</p>
        </div>

        <!-- Statistics -->
        <div class="stats-grid" id="stats-container">
            <div class="loading">Loading statistics...</div>
        </div>

        <!-- Tabs -->
        <div class="admin-tabs">
            <button class="tab-button active" data-tab="users">User Management</button>
            <button class="tab-button" data-tab="colleges">College Management</button>
            <button class="tab-button" data-tab="courses">Course Management</button>
        </div>

        <!-- Tab Contents -->
        <!-- Users Tab -->
        <div class="tab-content active" id="users-tab">
            <div class="search-bar">
                <input type="text" id="users-search" placeholder="Search users by name or email...">
                <select id="users-role-filter">
                    <option value="">All Roles</option>
                    <option value="student">Students</option>
                    <option value="admin">Admins</option>
                </select>
                <button class="btn btn-primary" onclick="loadUsers()">Search</button>
                <button class="btn btn-success" onclick="showCreateUserForm()">Add New User</button>
            </div>
            
            <div id="users-table-container">
                <div class="loading">Loading users...</div>
            </div>
        </div>

        <!-- Colleges Tab -->
        <div class="tab-content" id="colleges-tab">
            <div class="search-bar">
                <input type="text" id="colleges-search" placeholder="Search colleges...">
                <button class="btn btn-primary" onclick="loadColleges()">Search</button>
                <button class="btn btn-success" onclick="showCreateCollegeForm()">Add New College</button>
            </div>
            
            <div id="colleges-table-container">
                <div class="loading">Loading colleges...</div>
            </div>
        </div>

        <!-- Courses Tab -->
        <div class="tab-content" id="courses-tab">
            <div class="search-bar">
                <input type="text" id="courses-search" placeholder="Search courses...">
                <button class="btn btn-primary" onclick="loadCourses()">Search</button>
                <button class="btn btn-success" onclick="showCreateCourseForm()">Add New Course</button>
            </div>
            
            <div id="courses-table-container">
                <div class="loading">Loading courses...</div>
            </div>
        </div>
    </div>

    <!-- Modals will be created dynamically -->
    <div id="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div id="modal-content" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 600px; max-height: 80%; overflow-y: auto;">
        </div>
    </div>

    <script>
        // Check if user is admin
        if (!authManager.requireAuth()) {
            // User is not logged in, redirect happens in requireAuth
        }

        let currentPage = 1;
        let currentTab = 'users';

        // Check if user is admin on page load
        document.addEventListener('DOMContentLoaded', async () => {
            const user = apiService.getStoredUser();
            if (!user || user.role !== 'admin') {
                alert('Access denied. Admin privileges required.');
                window.location.href = 'index.html';
                return;
            }
            
            await loadStats();
            await loadUsers();
            setupTabs();
        });

        // Tab functionality
        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');
                    currentTab = tabId;

                    // Update active tab
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));

                    button.classList.add('active');
                    document.getElementById(tabId + '-tab').classList.add('active');

                    // Load content for the selected tab
                    switch(tabId) {
                        case 'users':
                            loadUsers();
                            break;
                        case 'colleges':
                            loadColleges();
                            break;
                        case 'courses':
                            loadCourses();
                            break;
                    }
                });
            });
        }

        // Load statistics
        async function loadStats() {
            try {
                const response = await apiService.getUserStats();
                const stats = response.data;
                
                document.getElementById('stats-container').innerHTML = `
                    <div class="stat-card">
                        <h3>${stats.totalUsers}</h3>
                        <p>Total Users</p>
                    </div>
                    <div class="stat-card">
                        <h3>${stats.totalStudents}</h3>
                        <p>Students</p>
                    </div>
                    <div class="stat-card">
                        <h3>${stats.totalAdmins}</h3>
                        <p>Admins</p>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading stats:', error);
                document.getElementById('stats-container').innerHTML = '<p>Error loading statistics</p>';
            }
        }

        // Load users
        async function loadUsers(page = 1) {
            const container = document.getElementById('users-table-container');
            container.innerHTML = '<div class="loading">Loading users...</div>';
            
            try {
                const role = document.getElementById('users-role-filter')?.value || '';
                const response = await apiService.getAllUsers(page, 10, role);
                const data = response.data;
                
                let html = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>GPA</th>
                                <th>Total Marks</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                data.docs.forEach(user => {
                    html += `
                        <tr>
                            <td>${user.name}</td>
                            <td>${user.email}</td>
                            <td><span class="badge badge-${user.role}">${user.role}</span></td>
                            <td>${user.gpa || 'N/A'}</td>
                            <td>${user.totalMarks || 'N/A'}</td>
                            <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                            <td>
                                <button class="btn btn-secondary" onclick="editUser('${user._id}')">Edit Role</button>
                                <button class="btn btn-danger" onclick="deleteUser('${user._id}')">Delete</button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                
                // Add pagination
                if (data.totalPages > 1) {
                    html += '<div class="pagination">';
                    if (data.hasPrevPage) {
                        html += `<button onclick="loadUsers(${data.page - 1})">Previous</button>`;
                    }
                    for (let i = 1; i <= data.totalPages; i++) {
                        html += `<button class="${i === data.page ? 'active' : ''}" onclick="loadUsers(${i})">${i}</button>`;
                    }
                    if (data.hasNextPage) {
                        html += `<button onclick="loadUsers(${data.page + 1})">Next</button>`;
                    }
                    html += '</div>';
                }
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading users:', error);
                container.innerHTML = '<p>Error loading users</p>';
            }
        }

        // Load colleges (placeholder)
        async function loadColleges(page = 1) {
            const container = document.getElementById('colleges-table-container');
            container.innerHTML = '<div class="loading">Loading colleges...</div>';
            
            try {
                const response = await apiService.getAllColleges(page, 10);
                const data = response.data;
                
                let html = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Location</th>
                                <th>Contact</th>
                                <th>Courses</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                const colleges = data.docs || data;
                colleges.forEach(college => {
                    html += `
                        <tr>
                            <td>${college.name}</td>
                            <td>${college.location}</td>
                            <td>${college.contact?.phone || 'N/A'}</td>
                            <td>${college.courses?.length || 0}</td>
                            <td>
                                <button class="btn btn-secondary" onclick="editCollege('${college._id}')">Edit</button>
                                <button class="btn btn-danger" onclick="deleteCollege('${college._id}')">Delete</button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading colleges:', error);
                container.innerHTML = '<p>Error loading colleges</p>';
            }
        }

        // Load courses (placeholder)
        async function loadCourses() {
            const container = document.getElementById('courses-table-container');
            container.innerHTML = '<div class="loading">Loading courses...</div>';
            
            try {
                const response = await apiService.getAllCourses();
                const courses = response.data;
                
                let html = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                courses.forEach(course => {
                    html += `
                        <tr>
                            <td>${course.name}</td>
                            <td>${course.description || 'No description'}</td>
                            <td>
                                <button class="btn btn-secondary" onclick="editCourse('${course._id}')">Edit</button>
                                <button class="btn btn-danger" onclick="deleteCourse('${course._id}')">Delete</button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading courses:', error);
                container.innerHTML = '<p>Error loading courses</p>';
            }
        }

        // User management functions
        async function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                try {
                    await apiService.deleteUser(userId);
                    showSuccess('User deleted successfully');
                    await loadUsers();
                    await loadStats();
                } catch (error) {
                    showError('Error deleting user: ' + error.message);
                }
            }
        }

        function editUser(userId) {
            // Show role edit modal
            showModal(`
                <h3>Edit User Role</h3>
                <form id="edit-user-form">
                    <div class="form-group">
                        <label>Role:</label>
                        <select id="edit-user-role" required>
                            <option value="student">Student</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Update Role</button>
                    <button type="button" class="btn btn-secondary" onclick="hideModal()">Cancel</button>
                </form>
            `);

            document.getElementById('edit-user-form').onsubmit = async (e) => {
                e.preventDefault();
                const role = document.getElementById('edit-user-role').value;
                
                try {
                    await apiService.updateUserRole(userId, role);
                    showSuccess('User role updated successfully');
                    hideModal();
                    await loadUsers();
                    await loadStats();
                } catch (error) {
                    showError('Error updating user role: ' + error.message);
                }
            };
        }

        // Modal functions
        function showModal(content) {
            document.getElementById('modal-content').innerHTML = content;
            document.getElementById('modal-overlay').style.display = 'block';
        }

        function hideModal() {
            document.getElementById('modal-overlay').style.display = 'none';
        }

        // Close modal when clicking outside
        document.getElementById('modal-overlay').onclick = (e) => {
            if (e.target.id === 'modal-overlay') {
                hideModal();
            }
        };

        // Placeholder functions for other operations
        function showCreateUserForm() {
            alert('Create user form - To be implemented');
        }

        function showCreateCollegeForm() {
            alert('Create college form - To be implemented');
        }

        function showCreateCourseForm() {
            alert('Create course form - To be implemented');
        }

        function editCollege(id) {
            alert('Edit college - To be implemented');
        }

        function deleteCollege(id) {
            alert('Delete college - To be implemented');
        }

        function editCourse(id) {
            alert('Edit course - To be implemented');
        }

        function deleteCourse(id) {
            alert('Delete course - To be implemented');
        }
    </script>
</body>
</html>
